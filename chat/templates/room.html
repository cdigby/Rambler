<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chatroom</title>
  </head>
  <body>
    <textarea id="log" cols="80" rows="10"></textarea><br />
    <input id="chat_input" type="text" size="75" /><br />
    <input id="chat_submit" type="button" value="Send" />

    {{ request.user.username|json_script:"user_username" }} {{
    room_name|json_script:"room-name" }}

    <script>
          //var dt = new Date();
          //document.getElementById('date-time').innerHTML=dt;

              const roomName = JSON.parse(document.getElementById('room-name').textContent);
              const user_username = JSON.parse(document.getElementById('user_username').textContent);

              const chatSocket = new WebSocket(
                  'ws://'
                  + window.location.host
                  + '/ws/chat/'
                  + roomName
                  + '/'
              );

              chatSocket.onmessage = function(e) {
                  var data = JSON.parse(message.data);
                  if(data.error){
                      console.error(data.error + ": " + data.message)
                  }
                  if (data.join) {
                      console.log("Joining chat " + data.join)
                      getRoomChatMessages()
                  }
                  appendChatMessage(data, true, true)
                  if (data.messages_payload) {
                      handleMessagesPayload(data.messages, data.new_page_number)
                  }
              };
      ```
              document.getElementById('chat_input').focus():
              document.getElementById('chat_input').onkeyup = function(e) {
                  if(e.keycode === 13) {

                  }
                  else if (e.keyCode === 13) {
                      document.getElementById('chat_submit').click();
                  }
              };

              document.getElementById('chat_submit')

      ```
              chatSocket.onclose = function(e) {
                  console.error('Chat socket closed unexpectedly');
              };

              document.querySelector('#chat_input').focus();
              document.querySelector('#chat_input').onkeyup = function(e) {
                  if (e.keyCode === 13) {  // enter, return
                      document.querySelector('#chat_submit').click();
                  }
              };

              document.querySelector('#chat_submit').onclick = function(e) {
                  const messageInputDom = document.querySelector('#chat_input');
                  const message = messageInputDom.value;
                //  const timeStamp = dt;
                  chatSocket.send(JSON.stringify({
                      'command': 'send',
                      'message': message,
                      'room_id': '{{room_id}}'
                     // 'username': user_username,
                    //  'timeStamp': timeStamp,
                  }));
                  messageInputDom.value = '';
              };

              function appendChatMessage(data, maintainPosition, isNewMessage){
                  message = data['message']
                  msg_id = data['msg_id']
                  usrname = data['username']
                  user_id = data['user_id']
                  timestamp = data['natural_timestamp']

                  var msg = message + '\n';
                  var username = usrname + ": ";
                  createChatMessageElement(msg,msg_id,username,user_id, timestamp, maintainPosition, isNewMessage)
              }

              function handleMessagesPayload(messages, new_page_number){
                  if(messages != null && messages != "undefined" && messages != "None"){
                      setPageNumber(new_page_number)
                      messages.forEach(function(message){
                          appendChatMessage(message, true, false)
                      })
                  }
              }

              function setPageNumber(pageNumber){
                  document.getElementById("id_page_number").innerHTML = pageNumber
      	}

      	function setPaginationExhausted(){
      		setPageNumber("-1")
      	}

      	function getRoomChatMessages(){
      		var pageNumber = document.getElementById("id_page_number").innerHTML
      		if(pageNumber != "-1"){
      			setPageNumber("-1")
      			chatRoomSocket.send(JSON.stringify({
      				"command": "get_room_chat_messages",
      				"room_id": "{{room_id}}",
      				"page_number": pageNumber,
      			}));
      		}
      	}

      	document.getElementById("log").addEventListener("scroll", function(e){
      		var chatLog = document.getElementById("log")
      		chatLog.addEventListener("scroll", function(e){
      			if ((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)) {
      				getRoomChatMessages()
      			}
      		});
      	})

      	function createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage){
      		var chatLog = document.getElementById("id_chat_log")

      		var newMessageDiv = document.createElement("div")
      		newMessageDiv.classList.add("d-flex")
      		newMessageDiv.classList.add("flex-row")
      		newMessageDiv.classList.add("message-container")

      		var div1 = document.createElement("div")
      		div1.classList.add("d-flex")
      		div1.classList.add("flex-column")

      		var div2 = document.createElement("div")
      		div2.classList.add("d-flex")
      		div2.classList.add("flex-row")

      		var usernameSpan = document.createElement("span")
      		usernameSpan.addEventListener("click", function(e){
      			selectUser(user_id)
      		})
      		usernameSpan.classList.add("username-span")
      		usernameSpan.innerHTML = username
      		div2.appendChild(usernameSpan)

      		var timestampSpan = document.createElement("span")
      		timestampSpan.innerHTML = timestamp
      		timestampSpan.classList.add("timestamp-span")
      		timestampSpan.classList.add("d-flex")
      		timestampSpan.classList.add("align-items-center")
      		timestampSpan.addEventListener("click", function(e){
      			selectUser(user_id)
      		})
      		div2.appendChild(timestampSpan)

      		div1.appendChild(div2)

      		var msgP = document.createElement("p")
      		msgP.innerHTML = validateText(msg)
      		msgP.classList.add("msg-p")
      		div1.appendChild(msgP)

      		newMessageDiv.appendChild(div1)

      		if(isNewMessage){
      			chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
      		}
      		else{
      			chatLog.appendChild(newMessageDiv)
      		}

      		if(!maintainPosition){
      			chatLog.scrollTop = chatLog.scrollHeight
      		}
    </script>
  </body>
</html>
